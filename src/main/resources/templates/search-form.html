<!DOCTYPE html>
<html xmlns:th = "http://www.thymeleaf.org">
    <body>
        <div th:fragment = "search-form" >
            <link rel="stylesheet" type="text/css" media="all" href="../static/css/search-form.css" th:href="@{/css/search-form.css}"/>
            <form id = "search-from" action="#" th:action="@{/search}" th:object="${searchRequest}" method = "get">
                <input id = "search" type = "text" placeholder="search..." th:field="*{content}"/>
                <button type="submit" value="Search" id="bth-search"></button>
            </form>
            <script type="text/javascript" src="../static/js/jquery.autocomplete.min.js" th:src="@{/js/jquery.autocomplete.min.js}" ></script>
            <script th:inline="javascript">
                /*<![CDATA[*/
                    var mapEnambled = false;

                    /*$(document).ready(function () {

                        $("#search-form").submit(function (event) {

                            event.preventDefault();

                            search_ajax_submit();

                        });

                    });*/

                    function search_ajax_submit() {

                        var searchRequest = {}

                        searchRequest["content"] = $("#search").val();

                        console.log(searchRequest);

                        $("#btn-search").prop("disabled", true);

                        $.ajax({
                            type: "POST",
                            contentType: "application/json",
                            url: "./search",
                            data: JSON.stringify(searchRequest),
                            dataType: 'json',
                            cache: false,
                            timeout: 600000,
                            success: function (data) {
                                $('#middle').load(data);

                                console.log("SUCCESS : ", data);
                                $("#btn-search").prop("disabled", false);

                            },
                            error: function (e) {

                                console.log("ERROR : ", e);
                                $("#btn-search").prop("disabled", false);

                            }
                        });

                    }

                    $(document).ready(function() {
                        let markers = {};
                        $('#search').autocomplete({
                            serviceUrl: './api/gis/getAddressObjects',
                            paramName: "street",
                            delimiter: ",",
                            transformResult: function(response) {
                                for (var key in markers) {
                                    mymap.removeLayer(markers[key]);
                                }

                                return {suggestions: $.map($.parseJSON(response), function(item) {

                                        if(mapEnambled) {
                                            markers[item.id] = new L.marker([item.lat, item.lon]);

                                            mymap.addLayer(markers[item.id]);
                                        }

                                        return {value: item.city
                                            + "," + item.street
                                            + "-" + item.number, data: item.id};})};
                            }
                        });
                    });
                /*]]>*/
            </script>
        </div>
    </body>
</html>